# 配置格式升级指南

## 重要变更

**已完全移除旧的 THRESHOLD_PRICE 配置方式**，现在只支持新的 PRICE_INTERVALS 配置格式。

## 新配置格式

### 环境变量配置

```bash
# 价格区间配置
PRICE_INTERVALS=1045-1047:5,1047-1051:10,1051-1055:3

# @用户列表
FEI_SHU_AT_USER=ou_xxx,ou_yyy
```

### 配置格式说明

- **格式**：`下限-上限:最大告警次数`，多个区间用逗号分隔
- **示例**：`1045-1047:5,1047-1051:10`
  - `[1045, 1047)` 区间最多告警5次
  - `[1047, 1051)` 区间最多告警10次

### 区间规则

- **左闭右开**：`[下限, 上限)`，包含下限，不包含上限
- **独立计数**：每个区间的告警次数独立计数
- **1小时重置**：告警计数缓存有效期为1小时，自动清零

## 从旧配置迁移

### 旧配置（已不再支持）

```bash
THRESHOLD_PRICE=1000,995,990,985,980
MAX_ALERT_COUNT=10
```

这会生成4个区间，所有区间共用最大告警次数10次：
- [995, 1000) → 10次
- [990, 995) → 10次
- [985, 990) → 10次
- [980, 985) → 10次

### 迁移到新配置

**方案1：保持相同行为（所有区间相同告警次数）**

```bash
PRICE_INTERVALS=995-1000:10,990-995:10,985-990:10,980-985:10
```

**方案2：差异化配置（不同区间不同告警次数）**

```bash
# 高价区间多次提醒，低价区间少次提醒
PRICE_INTERVALS=995-1000:15,990-995:12,985-990:8,980-985:5
```

## 你当前的配置转换

### 当前配置

```bash
THRESHOLD_PRICE=1000,995,990,985,980,975,970,965,960,955,950
MAX_ALERT_COUNT=10
```

### 转换为新格式

```bash
PRICE_INTERVALS=995-1000:10,990-995:10,985-990:10,980-985:10,975-980:10,970-975:10,965-970:10,960-965:10,955-960:10,950-955:10
```

或者根据实际需求调整不同区间的告警次数：

```bash
# 示例：接近1000的区间更重要，增加告警次数
PRICE_INTERVALS=995-1000:20,990-995:15,985-990:12,980-985:10,975-980:8,970-975:8,965-970:6,960-965:6,955-960:5,950-955:5
```

## 配置方式

### 方式1：通过Web页面（推荐）

1. 访问配置页面：`https://kdfxdjdbmqyh.ap-northeast-1.clawcloudrun.com/config`
2. 在"价格区间配置"中输入新格式：`1045-1047:5,1047-1051:10`
3. 点击"保存配置"

### 方式2：修改环境变量

编辑 `.env` 文件：

```bash
# 删除旧配置
# THRESHOLD_PRICE=...  ← 删除
# MAX_ALERT_COUNT=...  ← 删除

# 添加新配置
PRICE_INTERVALS=995-1000:10,990-995:10,985-990:10
FEI_SHU_AT_USER=ou_xxx
```

然后重启程序。

## 飞书卡片显示

配置成功后，飞书消息中会显示：

```
⚙️ 当前推送配置
价格区间：
[995.00, 1000.00) 最多10次
[990.00, 995.00) 最多10次
[985.00, 990.00) 最多10次
@用户数：1 个用户
```

## 常见问题

### Q: 旧配置还能用吗？
A: 不能。已完全移除对 `THRESHOLD_PRICE` 和 `MAX_ALERT_COUNT` 的支持。

### Q: 如果不配置 PRICE_INTERVALS 会怎样？
A: 系统不会发送任何告警，仅推送价格信息（不@用户）。

### Q: 区间必须连续吗？
A: 不必须。你可以配置非连续区间，例如：`1000-1010:5,1020-1030:10`

### Q: 区间可以重叠吗？
A: 不建议。如果价格同时在多个区间内，只会触发第一个匹配的区间。

### Q: 告警计数什么时候重置？
A: 每个区间的告警计数缓存有效期为1小时，过期后自动清零。

### Q: @用户列表可以为每个区间单独配置吗？
A: 目前不支持。所有区间共用同一个 `FEI_SHU_AT_USER` 配置。

## 配置示例

### 示例1：单个区间

```bash
# 只监控 [1045, 1050) 区间，最多告警5次
PRICE_INTERVALS=1045-1050:5
```

### 示例2：多个连续区间

```bash
# 监控三个连续区间
PRICE_INTERVALS=1040-1045:3,1045-1050:5,1050-1055:8
```

### 示例3：非连续区间

```bash
# 只监控高价和低价区间
PRICE_INTERVALS=1000-1010:10,1050-1060:10
```

### 示例4：大量区间

```bash
# 覆盖广泛的价格范围
PRICE_INTERVALS=950-955:5,955-960:6,960-965:6,965-970:8,970-975:8,975-980:10,980-985:10,985-990:12,990-995:15,995-1000:20
```

## 测试建议

1. **先在本地测试** - 修改配置后先在本地运行验证
2. **检查日志** - 观察程序启动日志，确认配置已正确加载
3. **访问配置页面** - 通过 `/config` 页面确认配置显示正确
4. **等待推送** - 等待下次定时推送，检查飞书卡片显示

## 升级步骤

1. **备份当前配置** - 保存当前的 `.env` 文件
2. **转换配置格式** - 按照上述方法转换为新格式
3. **更新配置** - 修改 `.env` 文件或通过Web页面更新
4. **重启程序** - 如果修改了环境变量，需要重启程序
5. **验证配置** - 检查日志和飞书推送，确认配置生效
