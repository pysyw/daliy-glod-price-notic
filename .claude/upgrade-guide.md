# 多价格区间配置升级指南

## 功能说明

现在支持**独立配置多个价格区间**，每个区间可以设置独立的最大告警次数。

## 配置格式对比

### 旧格式（向后兼容）
```bash
# 价格阈值（从大到小排序）
THRESHOLD_PRICE=1051,1047,1045

# 全局最大告警次数
MAX_ALERT_COUNT=10
```

**说明**：
- 系统会自动计算区间：[1047, 1051) 和 [1045, 1047)
- 所有区间共用同一个最大告警次数（10次）

### 新格式（推荐）
```bash
# 价格区间配置
PRICE_INTERVALS=1045-1047:5,1047-1051:10,1051-1055:3
```

**说明**：
- [1045, 1047) 区间最多告警5次
- [1047, 1051) 区间最多告警10次
- [1051, 1055) 区间最多告警3次
- 每个区间的告警次数独立计数

## 你当前的配置转换示例

### 当前配置（旧格式）
```bash
THRESHOLD_PRICE=1000,995,990,985,980,975,970,965,960,955,950
MAX_ALERT_COUNT=10
```

这会生成10个价格区间，每个区间最多告警10次：
- [995, 1000) → 告警10次
- [990, 995) → 告警10次
- [985, 990) → 告警10次
- ...以此类推

### 转换为新格式（示例）

如果你希望不同区间有不同的告警频率，可以这样配置：

```bash
# 高价区间（接近1000）- 关注度高，多次提醒
PRICE_INTERVALS=995-1000:15,990-995:12,985-990:10

# 或者所有区间都保持10次
PRICE_INTERVALS=995-1000:10,990-995:10,985-990:10,980-985:10,975-980:10,970-975:10,965-970:10,960-965:10,955-960:10,950-955:10
```

## 如何升级

### 方案1：通过Web配置页面（推荐）

1. 访问配置页面：`https://kdfxdjdbmqyh.ap-northeast-1.clawcloudrun.com/config`
2. 在"价格区间配置"输入框中输入新格式配置（例如：`1045-1047:5,1047-1051:10`）
3. 点击"保存配置"

### 方案2：修改环境变量

1. 编辑 `.env` 文件
2. 添加 `PRICE_INTERVALS` 配置
3. 重启程序

```bash
# 添加新格式配置
PRICE_INTERVALS=995-1000:10,990-995:10,985-990:10

# 旧配置可以保留（不会生效）或删除
# THRESHOLD_PRICE=1000,995,990
# MAX_ALERT_COUNT=10
```

## 告警计数机制

### 旧格式
- 缓存key：`alert_interval_0`, `alert_interval_1`, ...
- 所有区间共用同一个最大告警次数

### 新格式
- 缓存key：`alert_interval_0`, `alert_interval_1`, ...
- 每个区间使用配置中指定的独立最大告警次数

### 缓存过期时间
- **1小时**自动清零
- 即每小时每个区间的告警计数会重置

## 飞书卡片显示变化

### 旧格式显示
```
⚙️ 当前推送配置
价格区间：
阈值：1000.00, 995.00, 990.00，最大告警次数：10
@用户数：1 个用户
```

### 新格式显示
```
⚙️ 当前推送配置
价格区间：
[995.00, 1000.00) 最多10次
[990.00, 995.00) 最多10次
[985.00, 990.00) 最多10次
@用户数：1 个用户
```

## 测试建议

1. **保持现有配置运行** - 旧格式完全向后兼容，无需立即迁移
2. **在测试环境验证** - 先在本地或测试环境试用新格式
3. **逐步迁移** - 确认新格式工作正常后再在生产环境使用

## 常见问题

### Q: 新旧格式可以同时存在吗？
A: 不可以。程序优先读取 `PRICE_INTERVALS`，如果存在则忽略 `THRESHOLD_PRICE` 和 `MAX_ALERT_COUNT`。

### Q: 告警计数会因为格式切换而重置吗？
A: 是的。缓存key的含义会变化，切换格式后告警计数会从头开始。

### Q: 区间必须连续吗？
A: 不必须。你可以配置非连续区间，例如：`1000-1010:5,1020-1030:10`

### Q: 区间可以重叠吗？
A: 不建议。如果价格同时在多个区间内，只会触发第一个匹配的区间。

### Q: @用户列表需要为每个区间单独配置吗？
A: 目前不需要。所有区间共用同一个 `FEI_SHU_AT_USER` 配置。未来如有需求可扩展支持。
